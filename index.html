<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>WattPace V0.1</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --swiss-red: #e63946; --dark: #1d3557; --gray: #64748b; --light-bg: #f8fafc; }
        body { font-family: 'Inter', sans-serif; background: var(--light-bg); margin: 0; padding: 20px; font-size: 11px; }
        .layout { max-width: 100%; margin: auto; display: grid; grid-template-columns: 1fr 300px; gap: 15px; }
        .card { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .toolbar { display: flex; gap: 8px; margin-bottom: 15px; align-items: center; }
        .btn { padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 11px; transition: 0.2s; }
        .btn-gpx { background: var(--dark); color: white; }
        .btn-export { background: #059669; color: white; }
        .btn-add { background: #457b9d; color: white; }
        .btn-calc { background: var(--swiss-red); color: white; }
        .btn-load { background: #6366f1; color: white; }
        .btn-reset { background: #94a3b8; color: white; }
        #chart-container { height: 250px; margin-bottom: 15px; cursor: crosshair; }
        .wp-row { display: grid; grid-template-columns: 30px 40px 1fr 70px 60px 100px 90px 90px 100px 75px 70px 80px 30px; gap: 8px; padding: 10px; border-bottom: 1px solid #eee; align-items: center; }
        .wp-header { font-weight: bold; color: var(--gray); text-transform: uppercase; font-size: 0.6rem; background: #f1f5f9; position: sticky; top: 0; z-index: 10; }
        input, textarea { padding: 5px; border: 1px solid #cbd5e1; border-radius: 4px; width: 100%; font-size: 11px; }
        .badge { padding: 4px; border-radius: 4px; text-align: center; font-weight: bold; font-family: monospace; }
        .eta { background: var(--dark); color: white; }
        .side { background: var(--dark); color: white; position: sticky; top: 20px; height: fit-content; text-align: center; padding: 15px; border-radius: 12px; }
        #helpModal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.8); align-items:center; justify-content:center; padding:20px; }
        .help-content { background: white; color: var(--dark); max-width: 650px; width: 100%; max-height: 90vh; overflow-y: auto; padding: 30px; border-radius: 12px; position: relative; }
        .section-detail { display: none; background: #fffcfc; padding: 15px; border: 1px solid #feb2b2; border-radius: 0 0 8px 8px; }
    </style>
</head>
<body>

<div class="layout">
    <div class="card">
        <div class="toolbar">
            <button class="btn btn-gpx" onclick="document.getElementById('gpxIn').click()">üìÅ IMPORTER GPX</button>
            <input type="file" id="gpxIn" accept=".gpx" style="display:none">
            <button class="btn btn-export" onclick="exportGPX()">üíæ EXPORTER GPX</button>
            <button class="btn btn-add" onclick="addManualWP()">‚ûï POINT</button>
            <button class="btn btn-calc" onclick="calculate(); saveToLocal();">üîÑ CALCULER</button>
            <button class="btn" style="background: var(--gray); color: white;" onclick="toggleHelp()">‚ùì MODE D'EMPLOI</button>
            <button class="btn btn-load" onclick="loadFromLocal()">üì• R√âCUP√âRER</button>
            <button class="btn btn-reset" onclick="resetAll()">üóëÔ∏è RESET</button>
            <div style="flex-grow:1"></div>
            <input type="time" id="startTime" value="08:00" style="width:85px" onchange="calculate(); saveToLocal();">
        </div>
        <div id="chart-container"><canvas id="mainChart"></canvas></div>
        <div class="wp-header wp-row">
            <div onclick="toggleAllDetails()">üëÅÔ∏è</div><div>Icon</div><div>Nom</div><div>Km</div><div>Alt.</div><div>D+/- Seg.</div><div>D+/- Fait</div><div>D+/- Reste</div><div>Allure</div><div>Pause</div><div>Passage</div><div>Course</div><div></div>
        </div>
        <div id="wpList"></div>
    </div>
    <div class="card side">
        <h3>R√©capitulatif</h3>
        <p>Distance : <b id="statDist">0</b> km</p>
        <p>D√©nivel√© : <br><span style="color:#10b981">‚ñ≤ <span id="statDplus">0</span>m</span> / <span style="color:#ef4444">‚ñº <span id="statDminus">0</span>m</span></p>
        <hr style="opacity:0.2">
        <p>ARRIV√âE ESTIM√âE</p>
        <div style="font-size: 2.2rem; font-weight: 900; color: var(--swiss-red);" id="finalEta">--:--</div>
        <p>CHRONO TOTAL : <b id="finalRaceTime">--</b></p>
        <p>ALLURE MOYENNE : <b id="avgPace">--:--</b></p>
    </div>
</div>

<div id="helpModal">
    <div class="help-content">
        <button onclick="toggleHelp()" style="position:absolute; right:15px; top:15px; border:none; background:none; font-size:2rem; cursor:pointer;">&times;</button>
        <h1 style="color:var(--swiss-red); margin-top:0;">WattPace</h1>
        <div style="line-height:1.6; font-size:12px;">
            <h3>üìñ Mode d'Emploi : WattPace</h3>
            <p>Bienvenue sur le test de <b>WattPace</b>, votre partenaire de planification strat√©gique pour le trail et la course √† pied.</p>
            <h3>üöÄ D√©marrage Rapide</h3>
            <p>Ouvrez le lien dans votre navigateur, importez votre parcours : Cliquez sur <b>üìÅ IMPORTER GPX</b> et s√©lectionnez votre trac√©.<br>
            R√©glez votre d√©part : Indiquez votre heure de d√©part en haut √† droite.</p>
            <h3>‚è±Ô∏è Planification de Course</h3>
            <p><b>Ajouter des points :</b> Cliquez n'importe o√π sur le graphique d'√©l√©vation principal ou utilisez le bouton ‚ûï POINT pour ajouter un ravitaillement ou un sommet.<br>
            <b>D√©finir l'effort :</b> Dans le tableau, ajustez l'Allure (min/km) et le temps de Pause (min) pour chaque section. Attention, pour l'allure, celle-ci doit √™tre s√©par√©e par ":" entre les min et sec afin d'√™tre pris en compte par l'application.<br>
            <b>Analyse d√©taill√©e :</b> Cliquez sur l'ic√¥ne üëÅÔ∏è √† gauche d'un point pour ouvrir le profil pr√©cis de la section (pentes moyennes, D+, D- et notes).</p>
            <h3>üìä Lecture des R√©sultats</h3>
            <p><b>Passage :</b> Heure r√©elle estim√©e √† ce point.<br>
            <b>Course :</b> Temps de course √©coul√© depuis le d√©part.<br>
            <b>Allure Moyenne :</b> V√©rifiez votre allure globale (incluant les pauses) dans la barre lat√©rale pour voir si elle correspond √† votre objectif.</p>
            <h3>üíæ Sauvegarde et Export</h3>
            <p>Vos donn√©es sont sauvegard√©es sur votre appareil.<br>
            Cliquez sur <b>üíæ EXPORTER GPX</b> pour r√©cup√©rer votre trac√© avec tous vos nouveaux points de passage int√©gr√©s pour votre montre GPS (Waypoint).</p>
            <div style="background:#f1f5f9; padding:15px; border-radius:8px; border-left:4px solid var(--swiss-red);">
                <h3>üí° Conseil pour des trac√©s propres (GPX "Bruit√©")</h3>
                <p>Il arrive que certains fichiers GPX soient "bruit√©s" : ils contiennent trop de points inutiles ou des erreurs d'altitude en dents de scie, ce qui fausse les calculs de d√©nivel√©. La solution recommand√©e : importez-le dans Garmin Connect (ou autre application), enregistrez-le, puis r√©-exportez-le. Garmin (ou autre) applique automatiquement un lissage intelligent qui rend la lecture beaucoup plus fluide. Il ne reste plus qu'√† le r√©-importer dans WattPace.</p>
            </div>
        </div>
        <button class="btn btn-calc" onclick="toggleHelp()" style="width:100%; margin-top:20px;">J'AI COMPRIS</button>
    </div>
</div>

<script>
let fullTrace = []; let waypoints = []; let mainChart = null; let detailCharts = {}; let allOpen = false;

function toggleHelp() {
    const modal = document.getElementById('helpModal');
    modal.style.display = (modal.style.display === 'none' || modal.style.display === '') ? 'flex' : 'none';
}

function saveToLocal() { localStorage.setItem('swissPaceData', JSON.stringify({ waypoints, startTime: document.getElementById('startTime').value })); }
function loadFromLocal() { const saved = localStorage.getItem('swissPaceData'); if (saved) { const data = JSON.parse(saved); waypoints = data.waypoints; document.getElementById('startTime').value = data.startTime || "08:00"; render(); } }
function resetAll() { if(confirm("Effacer tout ?")) { localStorage.removeItem('swissPaceData'); location.reload(); } }

document.getElementById('gpxIn').onchange = e => {
    const reader = new FileReader();
    reader.onload = event => parseGPX(event.target.result);
    reader.readAsText(e.target.files[0]);
};

function parseGPX(xmlText) {
    const xml = new DOMParser().parseFromString(xmlText, "text/xml");
    const pts = Array.from(xml.querySelectorAll('trkpt'));
    let d = 0, dp = 0, dm = 0;
    fullTrace = pts.map((p, i) => {
        let lat = parseFloat(p.getAttribute('lat')), lon = parseFloat(p.getAttribute('lon')), ele = parseFloat(p.querySelector('ele')?.textContent || 0);
        if(i > 0) {
            d += haversine({lat: parseFloat(pts[i-1].getAttribute('lat')), lon: parseFloat(pts[i-1].getAttribute('lon'))}, {lat, lon});
            let diff = ele - parseFloat(pts[i-1].querySelector('ele')?.textContent || 0);
            if(diff > 0) dp += diff; else dm += Math.abs(diff);
        }
        return { x: d/1000, y: ele, dp, dm, lat, lon };
    });
    document.getElementById('statDist').innerText = fullTrace[fullTrace.length-1].x.toFixed(2);
    document.getElementById('statDplus').innerText = Math.round(dp);
    document.getElementById('statDminus').innerText = Math.round(dm);
    waypoints = [createWP("D√âPART", 0, fullTrace[0].y, 0, 0, 'üèÅ', true)];
    waypoints.push(createWP("ARRIV√âE", fullTrace[fullTrace.length-1].x, fullTrace[fullTrace.length-1].y, dp, dm, 'üèÅ', true));
    initMainChart(); render(); saveToLocal();
}

function initMainChart() {
    const ctx = document.getElementById('mainChart').getContext('2d');
    if(mainChart) mainChart.destroy();
    mainChart = new Chart(ctx, {
        type: 'line',
        data: { labels: fullTrace.map(p => p.x.toFixed(2)), datasets: [{ data: fullTrace.map(p => p.y), borderColor: '#e63946', borderWidth: 2, pointRadius: 0, fill: true, backgroundColor: 'rgba(230, 57, 70, 0.05)' }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false} },
            onClick: (e) => {
                const points = mainChart.getElementsAtEventForMode(e, 'nearest', { intersect: false }, true);
                if (points.length) {
                    const pt = fullTrace[points[0].index];
                    waypoints.push(createWP("Point", pt.x, pt.y, pt.dp, pt.dm, 'üìç'));
                    render(); saveToLocal();
                }
            }
        }
    });
}

function render() {
    const list = document.getElementById('wpList'); list.innerHTML = "";
    waypoints.sort((a,b) => a.dist - b.dist);
    waypoints.forEach((w, i) => {
        let isLast = (i === waypoints.length - 1);
        const container = document.createElement('div');
        container.innerHTML = `<div class="wp-row">
            <button class="btn" style="padding:2px 5px; background:#f1f5f9" onclick="toggleDetail(${i})">üëÅÔ∏è</button>
            <input type="text" value="${w.type}" onchange="waypoints[${i}].type=this.value; saveToLocal();">
            <input type="text" value="${w.name}" onchange="waypoints[${i}].name=this.value; saveToLocal();">
            <input type="number" step="0.1" value="${w.dist}" onchange="updatePoint(${i}, this.value)">
            <div>${w.ele}m</div>
            <div style="font-size:0.8rem; color:#10b981">+${i>0?Math.round(w.dp-waypoints[i-1].dp):0} / -${i>0?Math.round(w.dm-waypoints[i-1].dm):0}</div>
            <div style="font-size:0.7rem">+${w.dp} / -${w.dm}</div>
            <div style="font-size:0.7rem; color:#999">Reste: ${Math.round(document.getElementById('statDplus').innerText - w.dp)}m</div>
            ${isLast ? '<div></div>' : `<input type="text" value="${w.pace}" id="pace-${i}" onchange="calculate(); saveToLocal();">`}
            ${isLast ? '<div></div>' : `<input type="number" value="${w.pause}" id="pause-${i}" onchange="calculate(); saveToLocal();">`}
            <div class="badge eta" id="eta-${i}">--:--</div>
            <div class="badge" style="background:#e2e8f0" id="rt-${i}">--:--</div>
            ${w.fixed ? '<div></div>' : `<button onclick="waypoints.splice(${i},1); render(); saveToLocal();" style="border:none; color:red; cursor:pointer; background:none;">‚úï</button>`}
        </div><div id="detail-${i}" class="section-detail">...</div>`;
        list.appendChild(container);
    });
    calculate();
}

function calculate() {
    let startDec = timeToDec(document.getElementById('startTime').value), elapsed = 0;
    waypoints.forEach((w, i) => {
        if(i > 0) {
            let pIn = document.getElementById(`pace-${i-1}`).value;
            let p = pIn.split(':');
            elapsed += (w.dist - waypoints[i-1].dist) * (parseInt(p[0]||0) + (parseInt(p[1]||0)/60));
        }
        document.getElementById(`eta-${i}`).innerText = decToTime(startDec + (elapsed/60));
        document.getElementById(`rt-${i}`).innerText = formatDuration(elapsed);
        if(i < waypoints.length-1) elapsed += parseInt(document.getElementById(`pause-${i}`).value || 0);
    });
}

function haversine(p1, p2) {
    const R = 6371e3; const dLat = (p2.lat-p1.lat)*Math.PI/180, dLon = (p2.lon-p1.lon)*Math.PI/180;
    const a = Math.sin(dLat/2)**2 + Math.cos(p1.lat*Math.PI/180)*Math.cos(p2.lat*Math.PI/180)*Math.sin(dLon/2)**2;
    return R*2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}
function createWP(name, dist, ele, dp, dm, type, fixed=false) { return { name, dist: parseFloat(dist).toFixed(2), ele: Math.round(ele), dp: Math.round(dp), dm: Math.round(dm), pace: "10:00", pause: 0, type, fixed }; }
function timeToDec(t) { let p = t.split(':'); return parseInt(p[0]) + parseInt(p[1])/60; }
function decToTime(d) { d=d%24; let h=Math.floor(d), m=Math.round((d-h)*60); if(m==60){h++;m=0} return (h<10?'0'+h:h)+':'+(m<10?'0'+m:m); }
function formatDuration(m) { return Math.floor(m/60)+"h"+(Math.round(m%60)<10?'0':'')+Math.round(m%60); }
function exportGPX() { alert("Exportation..."); }
function toggleDetail(i) { document.getElementById(`detail-${i}`).style.display = (document.getElementById(`detail-${i}`).style.display === 'block') ? 'none' : 'block'; }
</script>
</body>
</html>
